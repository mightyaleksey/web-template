import { Packer } from 'roadroller'
import fs from 'fs'
import htmlMinify from 'html-minifier'
import posthtml from 'posthtml'

/**
 * posthtml plugin to remove script tags
 * for corresponding filenames
 */
function removeScriptTag (assets) {
  return tree => {
    return tree.walk(handleNodes)

    function handleNodes (node) {
      if (node == null || typeof node !== 'object') return node
      if (node.tag !== 'script') return node

      if (assets.some(asset => node.attrs?.src?.endsWith(asset.fileName))) {
        return null
      }

      return node
    }
  }
}

/**
 * Packs JavaScript and html code.
 * Returns "<script>{packed code}<script>"
 */
async function embedJS (src, jsAssets) {
  const html = (await posthtml()
    .use(removeScriptTag(jsAssets))
    .process(src)).html

  const inputs = [
    {
      data: [`document.write('${html}');`]
        .concat(jsAssets.map(asset => asset.code.trim()))
        .join(''),
      type: 'js',
      action: 'eval'
    }
  ]
  const options = await (async () => {
    if (process.env.USE_RR_CONFIG) {
      const config = await fs.promises.readFile(
        __dirname,
        'readroller-config.json'
      )

      return JSON.parse(config)
    } else {
      return { allowFreeVars: true }
    }
  })()

  const packer = new Packer(inputs, options)
  await packer.optimize()

  const { firstLine, secondLine } = packer.makeDecoder()
  return `<script>\n${firstLine}\n${secondLine}\n<script>`
}

export function roadrollerPlugin () {
  return {
    name: 'vite:roadroller',
    transformIndexHtml: {
      order: 'post',
      /**
       * src - string
       * id - asset
       * id.path - string
       * id.filename - string
       * id.bundle - chunks
       */
      handler: async (src, id) => {
        if (!id || !id.bundle) return src

        const options = {
          collapseInlineTagWhitespace: true,
          collapseWhitespace: true,
          includeAutoGeneratedTags: true,
          minifyCSS: { level: 2 },
          removeAttributeQuotes: true,
          removeComments: true,
          removeEmptyAttributes: true,
          removeOptionalTags: true,
          removeRedundantAttributes: true,
          removeScriptTypeAttributes: true,
          removeStyleLinkTypeAttributes: true,
          sortAttributes: true,
          sortClassName: true,
          useShortDoctype: true
        }

        const html = await htmlMinify.minify(src, options)

        const jsAssets = Object.values(id.bundle)
          .filter(asset => asset.fileName.endsWith('.js'))

        return embedJS(html, jsAssets)
      }
    }
  }
}
